<!DOCTYPE html>
<html lang="en">
<head>
    <include file="Public:meta" />
    <!-- this page specific styles -->
    <link rel="stylesheet" href="__CSS__/compiled/new-user.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="__VD__/fileinput/css/fileinput.css" media="all"  type="text/css" />
</head>
<body>
<div id="pad-wrapper" class="new-user">
    <div class="row header">
        <div class="col-md-12">
            <h3>Create Product</h3>
            <a class="btn-flat success return-btn" href="__URL__"> return list </a>
        </div>
    </div>

    <div class="row form-wrapper">
        <!-- left column -->
        <div class="col-md-12 with-sidebar">
            <div class="container">
                <form id="product_form" class="new_user_form" >
                    <div class="col-md-12 field-box">
                        <label for="name">Product name:</label>
                        <input class="col-md-6 form-control" type="text" id="name" name="name"/>
                    </div>
                    <div class="col-md-12 field-box">
                        <label for="size">Size:</label>
                        <select id="size" name="size" class="col-md-6">

                        </select>
                    </div>
                    <div class="col-md-12 field-box">
                        <label for="category">Category:</label>
                        <select id="category" name="category" class="col-md-6">

                        </select>
                    </div>
                    <div class="col-md-12 field-box">
                        <label for="type">Type:</label>
                        <select id="type" name="type" class="col-md-6">

                        </select>
                    </div>
                    <div class="col-md-12 field-box">
                        <label for="code">Code:</label>
                        <input class="col-md-6 form-control" type="text" id="code" name="code"/>
                    </div>

                    <div class="col-md-12 field-box">
                        <label for="price_cn">Chinese price:</label>
                        <div class="input-group">
                            <span class="input-group-addon">&yen;</span>
                            <input type="number" class="col-md-6 form-control" id="price_cn" name="price_cn" />
                            <a href="http://hl.anseo.cn/cal_CNY_To_KRW.aspx" style="line-height: 35px;margin-left: 20px;" target="_blank">Currency Service</a>
                        </div>
                    </div>
                    <div class="col-md-12 field-box">
                        <label for="price_kr">Korea price:</label>
                        <div class="input-group">
                            <span class="input-group-addon">&#8361;</span>
                            <input type="number" class="col-md-6 form-control" id="price_kr" name="price_kr" />
                        </div>
                    </div>
                    <div class="col-md-12 field-box">
                        <label for="manufacturer">Manufacturer:</label>
                        <input class="col-md-6 form-control" type="text" id="manufacturer" name="manufacturer"/>
                    </div>
                    <div class="col-md-12 field-box">
                        <label for="origin">Origin:</label>
                        <input class="col-md-6 form-control" type="text" id="origin" name="origin"/>
                    </div>
                    <div class="col-md-12 field-box">
                        <label for="status">Active?</label>
                        <input type="checkbox" value="1" id="status" name="status" checked />
                    </div>
                    <div class="col-md-12 field-box textarea">
                        <label for="description">Description:</label>
                        <textarea class="col-md-6" id="description" name="description" placeholder="Field limited to 150 characters" maxlength="150"></textarea>
                        <p class="form-text-malength"><span id="desc-limit" style="color:red;">0</span>/150</p>
                    </div>

                    <div class="col-md-12 field-box textarea">
                        <label for="upload">Image:</label>
                        <input id="upload" name="upload" class="file-loading" type="file" />
                        <input id="image" name="image" type="hidden" />
                    </div>

                    <div class="col-md-12 field-box textarea">
                        <label for="upload_input">Detail Image:</label>
                        <div id="upload_detail">
                            <input id="upload_input" name="upload_input[]" class="file-loading" type="file" multiple/>
                        </div>
                        <div id="detail_init">

                        </div>
                        <div id="detail_remove"></div>
                        <div id="detail_insert"></div>
                    </div>


                    <div class="col-md-6 field-box actions">
                        <input id="id" name="id" type="hidden"/>
                        <input type="submit" class="btn-glow primary" value="Modify">
                        <span>OR</span>
                        <input type="reset" value="Cancel" class="reset">
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<include file="Public:js_basic" />
<!-- this page specific script -->
<script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/jquery.validate.min.js"></script>
<script src="__JS__/additional-methods.js"></script>
<script src="__VD__/fileinput/js/fileinput.js" type="text/javascript"></script>

<script>
    $().ready(function() {
        //init config
        $.ajax({
            type: "post",
            url: "__URL__/ajaxConf",
            success: function (rtn){
                if(rtn.status){
                    $.each(rtn.list,function(index,value){
                        var element = "#" + index;
                        var html = '<option value="">--</option>';
                        $.each(value,function(index,value){
                            html+= '<option value="'+ index +'">'+ value + '</option>';
                        })

                        $(element).append(html);
                    })
                }else{
                    alert(rtn.info);
                }
            }
        });

        //init data
        var product_id = getUrlParameter('id');
        $.ajax({
            type: "post",
            url: "__URL__/ajaxProductInfo",
            data: {id:product_id},
            success: function (rtn){
                if(rtn.status){
                    $.each(rtn.list,function(index,value){
                        switch (index){
                            case 'image_show':
                                var image = value;
                                //image upload
                                var $upload = $("#upload");
                                if(image['preview'] != undefined){
                                    $upload.fileinput({
                                        uploadUrl: "__APP__/Board/Upload/uploadPic?folder=Products",
                                        uploadAsync: false,
                                        showUpload: false, // hide upload button
                                        showRemove: false, // hide remove button
                                        //minFileCount: 1,
                                        maxFileCount: 1,
                                        allowedFileExtensions: ["jpg", "png", "gif"],

                                        initialPreview: image['preview'],
                                        initialPreviewAsData: true,
                                        initialPreviewConfig:  image['config'],
                                        overwriteInitial: false
                                    }).on("filebatchselected", function(event, files) {
                                        // trigger upload method immediately after files are selected
                                        $upload.fileinput("upload");
                                    });
                                }else{
                                    $upload.fileinput({
                                        uploadUrl: "__APP__/Board/Upload/uploadPic?folder=Products",
                                        uploadAsync: false,
                                        showUpload: false, // hide upload button
                                        showRemove: false, // hide remove button
                                        //minFileCount: 1,
                                        maxFileCount: 1,
                                        allowedFileExtensions: ["jpg", "png", "gif"],
                                    }).on("filebatchselected", function(event, files) {
                                        // trigger upload method immediately after files are selected
                                        $upload.fileinput("upload");
                                    });
                                }

                                //image upload callback
                                $upload.on('filebatchpreupload', function(event, data) {
                                    data.jqXHR.complete(function(response){
                                        console.log('Upload success');
                                        $("#image").val(response.responseJSON.data[0].savename);
                                    })
                                });

                                //image remove callback
                                $upload.on('filesuccessremove', function(event, id) {
                                    console.log('Uploaded thumbnail successfully removed');
                                    $("#image").val("");
                                });
                                break;
                            case 'detail_img_show':
                                image = value;
                                var $upload_input = $("#upload_input");
                                if(image['preview'] != undefined ){
                                    $upload_input.fileinput({
                                        uploadUrl: "__APP__/Board/Upload/uploadPic?folder=Details",
                                        uploadAsync: false,
                                        showUpload: false, // hide upload button
                                        showRemove: false, // hide remove button
                                        maxFileCount: 15,
                                        allowedFileExtensions: ["jpg", "png", "gif"],

                                        initialPreview: image['preview'],
                                        initialPreviewAsData: true,
                                        initialPreviewConfig:  image['config'],
                                        overwriteInitial: false
                                        //initialCaption: image
                                    }).on("filebatchselected", function(event, files) {
                                        // trigger upload method immediately after files are selected
                                        $upload_input.fileinput("upload");
                                    });
                                }else{
                                    $upload_input.fileinput({
                                        uploadUrl: "__APP__/Board/Upload/uploadPic?folder=Details",
                                        uploadAsync: false,
                                        showUpload: false, // hide upload button
                                        showRemove: false, // hide remove button
                                        maxFileCount: 15,
                                        allowedFileExtensions: ["jpg", "png", "gif"]
                                    }).on("filebatchselected", function(event, files) {
                                        // trigger upload method immediately after files are selected
                                        $upload_input.fileinput("upload");
                                    });
                                }

                                //image upload callback
                                $upload_input.on('filebatchuploadsuccess', function(event, data) {
                                    data.jqXHR.complete(function(response){
                                        if(response.responseJSON.status){
                                            var block = $("#detail_insert");
                                            var html = '';
                                            var exist_length = $("#upload_detail").find(".file-preview-success").length;
                                            var upload_length = response.responseJSON.data.length;
                                            var start_index =  exist_length - upload_length ;
                                            if(start_index > 0){
                                                $.each($("#upload_detail").find(".file-preview-success"),function(index,element){
                                                    block.find("input").eq(index).attr('id',"detail-" + $(element).attr('id'));
                                                })
                                            }

                                            $.each(response.responseJSON.data,function(index,value){
                                                var id = "detail-" + $("#upload_detail").find(".file-preview-success").eq(start_index + index).attr('id');
                                                html += '<input type="hidden" name="detail_img_insert[]" id="'+ id +'" value="'+ value['savename'] +'" />';
                                            })

                                            block.append(html);
                                        }else{
                                            console.log('Upload failed');
                                        }
                                    })
                                });

                                //upload image remove callback
                                $upload_input.on('filesuccessremove', function(event, id) {
                                    var element = "#detail-" +id;
                                    $(element).remove();
                                    console.log('Uploaded thumbnail successfully removed');
                                });

                                //init preview image remove callback
                                $upload_input.on('filedeleted', function(event, key) {
                                    var element = "#detail-init" +key;
                                    var img_name = $(element).val();

                                    var html = '<input type="hidden" name="detail_img_remove[]" value="'+ img_name +'" />';
                                    $("#detail_remove").append(html);
                                    console.log('inti:Uploaded thumbnail successfully removed');
                                });
                                break;
                            case 'detail_img' :
                                var block = $("#detail_init");
                                var html = [];
                                $.each(value,function(index,value){
                                    var id = "detail-init" + index;
                                    html += '<input type="hidden" name="detail_img[]" id="'+ id +'" value="'+ value +'" />';
                                })

                                block.append(html);
                                break;
                            default :
                                var element = "#" + index;
                                $(element).val(value);
                                break;
                        }
                    })
                }else{
                    alert(rtn.info);
                }
            }
        });

        $("#desc").unbind('keyup change input paste').bind('keyup change input paste',function(){
            $("#desc-limit").text($(this).val().length);
        })

        //form validate
        $("#product_form").validate({
            rules: {
                name: "required",
                code: "required",
                price_cn: "required"
            },
            submitHandler: function (form) {
                var values = $(form).serializeArray();

                var _values = values.concat(
                    $("#form input[type=checkbox]:not(:checked)").map(
                        function() {
                            return {"name": this.name, "value": -1}
                        }).get()
                );
                $.ajax({
                    type: "post",
                    url: "__URL__/update",
                    data: _values,
                    success: function (rtn){
                        alert(rtn.info);
                        window.setTimeout(function(){
                            if ( rtn.url != undefined ) {
                                window.location.href = rtn.url;
                            }
                        }, 2000);
                    }
                });
                return false; // required to block normal submit since you used ajax
            }
        });
    });

</script>

</body>
</html>